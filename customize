#!/bin/bash

set -o errexit

export LC_ALL=en_US.utf8
export LANGUAGE=en_US.utf8
export LANG=en_US.utf8

KIVITENDO_VERSION="3.5.3"

PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
MUNIN_PLUGINS="
"

echo "* Activate munin plugins"
/usr/local/bin/munin-node-plugins ${MUNIN_PLUGINS}

echo "* Get latest"
apt-get -y update
apt-get -y upgrade
apt-get -y dist-upgrade

echo "* Install kivitendo"
mkdir -p /usr/local/src/kivitendo_documents
cd /usr/local/src/
chown -R www-data:staff kivitendo_documents
git clone https://github.com/kivitendo/kivitendo-erp.git
cd kivitendo-erp
git checkout -b release-${KIVITENDO_VERSION}
mkdir webdav
chown -R www-data users spool webdav templates
mv /usr/local/var/tmp/kivitendo.conf config/kivitendo.conf
cp scripts/boot/systemd/kivitendo-task-server.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable kivitendo-task-server.service
cpanm HTML::Restrict

echo "* Activate apache modules"
a2enmod fcgid  || true
a2enmod dav    || true
a2enmod dav_fs || true

echo "* Ensure bootstrap will run next time"
rm -rf /var/lib/bootstrap

echo "* Cleaning up."
apt-get -y purge git make gcc g++ build-essential
rm -rf /usr/local/var/tmp/*
history -c
